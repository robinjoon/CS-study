## 3. 메모리 계층
- 메모리 계층은 레지스터, 캐시, 메모리, 저장장치로 구성되어 있다.
- 메인 메모리는 CPU가 직접 접근할 수 있는 기억 장치
- 프로세스가 실행되려면 프로그램이 메모리에 올라와야 함
- 주소가 할당된 일련의 바이트들로 구성되어 있음
- CPU는 레지스터가 지시하는대로 메모리에 접근하여 다음에 수행할 명령어를 가져옴

##### 레지스터
- CPU 안에 있는 작은 메모리, 휘발성, 속도 가장 빠름, 기억 용량이 가장 적다.

##### 캐시
- L1, L2 캐시를 지징한다. 휘발성, 속도 빠름, 기억 용량이 적다.

#### 주기억장치
- RAM을 가리킨다. 휘발성, 속도 보통, 기억 용량이 보통이다.

##### 보조기억장치
- HDD, SDD를 일컬으며 휘발성, 속도 낮음, 기억 용량이 많다.

- 램은 하드디스크로부터 일정량의 데이터를 복사해서 임시 저장하고 이를 필요 시마다 CPU에 빠르게 전달하는 역할을 한다.

### MMU (Memory Management Unit, 메모리 관리 장치)
- 명령어 수행 시 메모리에 필요한 데이터가 없으면 해당 데이터를 우선 가져와야 함, 이 역할을 하는 것이 MMU임.
- 논리 주소를 물리주소로 변환해 준다.
- 메모리 보호나 캐시 관리 등 CPU가 메모리에 접근하는 것을 총 관리해주는 하드웨어임
- 메모리의 공간이 한정적이기 때문에, 사용자에게 더 많은 메모리를 제공하기 위해 '가상 주소'라는 개념이 등장했다. (가상 주소는 프로그램 상에서 사용자가 보는 주소 공간이라고 보면 된다.)
- 이 가상 주소에서 실제 데이터가 담겨 있는 곳에 접근하기 위해선 빠른 주소 변환이 필요한데, 이를 MMU가 도와주는 것이다.
- 즉, MMU의 역할은 다음과 같다고 말할 수 있다.
> MMU가 지원되지 않으면, physical address를 직접 접근해야 하기 때문에 부담이 있다.
MMU는 사용자가 기억장소를 일일이 할당해야 하는 불편을 없애준다.
프로세스의 크기가 실제 메모리의 용량을 초과해도 실행될 수 있게 해준다
또한 메인 메모리의 직접 접근은 비효율적이므로, CPU와 메인 메모리 속도를 맞추기 위해 캐시가 존재함.

#### MMU의 메모리 보호
- 프로세스는 독립적인 메모리 공간을 가져야 되고, 자신의 공간만 접근해야 한다.
- 따라서 한 프로세스에게 합법적인 주소 영역을 설정하고, 잘못된 접근이 오면 trap을 발생시키며 보호한다.
- base와 limit 레지스터를 활용한 메모리 보호 기법이다.
- base 레지스터는 메모리상의 프로세스 시작주소를 물리 주소로 저장한다. **(limit 레지스터는 프로세스의 사이즈를 저장한다.)**
- 프로세스의 접근 가능한 합법적인 메모리 영역(x)은 **base <= x < base+limit** 이고,이 영역 밖에서 접근을 요구하면 trap을 발생시키는 것이다.
- 안전성을 위해 base와 limit 레지스터는 커널 모드에서만 수정 가능하도록 설계했다. **(사용자 모드에서는 직접 변경할 수 없도록하기 위함이다.)**

### 캐시
- 주기억장치에 저장된 내용의 일부를 임시로 저장해두는 기억장치이다.
- CPU와 주기억장치의 속도 차이로 성능 저하를 방지하기 위한 방법이다.
- CPU가 이미 봤던걸 다시 재접근할 때, 메모리 참조 및 인출 과정에 대한 비용을 줄이기 위해 캐시에 저장해둔 데이터를 활용한다.
- 캐시는 플리플롭 소자로 구성되어 SRAM으로 되어있어서 DRAM보다 빠른 장점을 지닌다.

#### CPU와 기억장치의 상호작용
- CPU에서 주소를 전달 → 캐시 기억장치에 명령이 존재하는지 확인

> 명령어를 갖고 주기억장치로 접근 → 해당 명령어를 가진 데이터 인출 → 해당 명령어 데이터를 캐시에 저장 → 해당 명령어를 CPU로 전송 → 완료

- 이처럼 캐시를 잘 활용한다면 비용을 많이 줄일 수 있다.
- 따라서 CPU가 어떤 데이터를 원할지 어느정도 예측할 수 있어야 한다.
- 캐시에 많이 활용되는 쓸모 있는 정보가 들어있어야 성능이 높아진다.
- 적중률을 극대화시키기 위해 사용되는 것이 바로 **지역성의 원리**이다.

#### 지역성
- 기억 장치 내의 정보를 균일하게 액세스 하는 것이 아니라 한 순간에 특정부분을 집중적으로 참조하는 특성

- 지역성의 종류는 시간과 공간으로 나누어진다.

##### 시간 지역성
- 최근에 참조된 주소의 내용은 곧 다음에도 참조되는 특성

##### 공간 지역성 
- 실제 프로그램이 참조된 주소와 인접한 주소의 내용이 다시 참조되는 특성

#### 캐싱 라인
- 빈번하게 사용되는 데이터들을 캐시에 저장했더라도, 내가 필요한 데이터를 캐시에서 찾을 때 모든 데이터를 순회하는 것은 시간 낭비다.
- 즉, 캐시에 목적 데이터가 저장되어있을 때 바로 접근하여 출력할 수 있어야 캐시 활용이 의미있어진다.
- 따라서 캐시에 데이터를 저장할 시, 자료구조를 활용해 묶어서 저장하는데 이를 캐싱 라인이라고 부른다.
- 즉, 캐시에 저장하는 데이터에 데이터의 메모리 주소를 함께 저장하면서 빠르게 원하는 정보를 찾을 수 있다. (set이나 map 등을 활용)
